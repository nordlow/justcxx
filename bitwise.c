#include "bitwise.h"
#include "byterev.h"

__attribute__((constructor))
void bitcounts_init(void)
{
  for (int i = 0; i < 256; i++) {
    g_bitcounts_8[i] = uint32_countBits_parallel(i);
  }
  for (int i = 0; i < 65536; i++) {
    g_bitcounts_16[i] = uint32_countBits_parallel(i);
  }
}

/*! Table used in bit operations. */
uint8_t g_bitcounts_8[256];

/*! Table used in bit operations. */
uint8_t g_bitcounts_16[65536];

#if 0
uint8_t g_bitcounts_8[256] = {
  0x00, 0x01, 0x01, 0x02, 0x01, 0x02, 0x02, 0x03,
  0x01, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x04,
  0x01, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x04,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x01, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x04,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x01, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x04,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x04, 0x05, 0x05, 0x06, 0x05, 0x06, 0x06, 0x07,
  0x01, 0x02, 0x02, 0x03, 0x02, 0x03, 0x03, 0x04,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x04, 0x05, 0x05, 0x06, 0x05, 0x06, 0x06, 0x07,
  0x02, 0x03, 0x03, 0x04, 0x03, 0x04, 0x04, 0x05,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x04, 0x05, 0x05, 0x06, 0x05, 0x06, 0x06, 0x07,
  0x03, 0x04, 0x04, 0x05, 0x04, 0x05, 0x05, 0x06,
  0x04, 0x05, 0x05, 0x06, 0x05, 0x06, 0x06, 0x07,
  0x04, 0x05, 0x05, 0x06, 0x05, 0x06, 0x06, 0x07,
  0x05, 0x06, 0x06, 0x07, 0x06, 0x07, 0x07, 0x08
};
#endif

void
b8v_bitNot(uint8_t * out, const uint8_t * in,
           const int length)
{
  int x;
  for (x = 0; x < length; x++)
    out[x] = ~in[x];
}

void
b8v_bitAnd(uint8_t * out, const uint8_t * in1, const uint8_t * in2,
           const int length)
{
  int x;
  for (x = 0; x < length; x++)
    out[x] = in1[x] & in2[x];
}

void
b8v_bitAndNot(uint8_t * out, const uint8_t * in1, const uint8_t * in2,
              const int length)
{
  int x;
  for (x = 0; x < length; x++)
    out[x] = ~in1[x] & in2[x];
}

void
b8v_bitOr(uint8_t * out, const uint8_t * in1, const uint8_t * in2,
          const int length)
{
  int x;
  for (x = 0; x < length; x++)
    out[x] = in1[x] | in2[x];
}

void
b8v_bitXor(uint8_t * out, const uint8_t * in1, const uint8_t * in2,
           const int length)
{
  int x;
  for (x = 0; x < length; x++)
    out[x] = in1[x] ^ in2[x];
}

/*!
 * Conversions between machines with different byte orders.
 */

void
b16v_toggleLittleEndian(uint16_t * out, const uint16_t * in, int n)
{
#if defined(CONFIG_LITTLE_ENDIAN)
  b16v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int16_toggleLittleEndian(in[i]);
#endif
}

void
b16v_toggleBigEndian(uint16_t * out, const uint16_t * in, int n)
{
#if defined(CONFIG_BIG_ENDIAN)
  b16v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int16_toggleBigEndian(in[i]);
#endif
}

void
b16v_togglePDPEndian(uint16_t * out, const uint16_t * in, int n)
{
#if defined(CONFIG_PDP_ENDIAN)
  b16v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int16_togglePDPEndian(in[i]);
#endif
}

void
b32v_toggleLittleEndian(uint32_t * out, const uint32_t * in, int n)
{
#if defined(CONFIG_LITTLE_ENDIAN)
  b32v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int32_toggleLittleEndian(in[i]);
#endif
}

void
b32v_toggleBigEndian(uint32_t * out, const uint32_t * in, int n)
{
#if defined(CONFIG_BIG_ENDIAN)
  b32v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int32_toggleBigEndian(in[i]);
#endif
}

void
b32v_togglePDPEndian(uint32_t * out, const uint32_t * in, int n)
{
#if defined(CONFIG_PDP_ENDIAN)
  b32v_copy(out, in, n);
#else
  int i;
  for (i = 0; i < n; i++)
    out[i] = int32_togglePDPEndian(in[i]);
#endif
}

pure int
int_bits_needed(int power_of_two)
{
  int j;
  if (power_of_two < 2) {
    leprintf("Argument %d is too small.\n", power_of_two);
    return -1;
  }
  for (j = 0;; j++) {
    if (power_of_two & (1 << j)) {
      return j;
    }
  }
}
